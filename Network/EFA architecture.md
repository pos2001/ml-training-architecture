


```
EFA 설치 확인 = 자동차 출고 전 점검 🚗

fi_info --version:
└── 엔진 버전 확인 (핵심 부품)

cat /opt/amazon/efa_installed_packages:
└── 전체 부품 목록 확인
    ├── ✅ 엔진 (libfabric)
    ├── ✅ 변속기 (OpenMPI)
    ├── ✅ 바퀴 (RDMA)
    ├── ✅ 전자장치 (EFA 드라이버)
    └── ✅ 계기판 (유틸리티)

결과:
└── 모든 부품 정상 → 출고 가능! ✅
```




### 통합 플로우차트
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     개발 단계 (개발자의 설계 결정)                            │
└─────────────────────────────────────────────────────────────────────────────┘
                                    ↓
                    ┌───────────────────────────────┐
                    │  고성능 HPC 통신 필요?        │
                    │  (MPI, NCCL 등)              │
                    └───────────────────────────────┘
                                    ↓
                    ┌───────────────┴───────────────┐
                    ↓                               ↓
            ┌───────────────┐               ┌───────────────┐
            │     [예]      │               │   [아니오]    │
            └───────────────┘               └───────────────┘
                    ↓                               ↓
┌───────────────────────────────────┐   ┌───────────────────────────────────┐
│   libfabric API로 코드 작성       │   │   Socket API로 코드 작성          │
├───────────────────────────────────┤   ├───────────────────────────────────┤
│ #include <rdma/fabric.h>          │   │ #include <sys/socket.h>           │
│ #include <rdma/fi_domain.h>       │   │ #include <netinet/in.h>           │
│                                   │   │                                   │
│ fi_getinfo(...)                   │   │ socket(...)                       │
│ fi_domain(...)                    │   │ connect(...)                      │
│ fi_endpoint(...)                  │   │ send(...)                         │
│ fi_send(...)                      │   │ recv(...)                         │
└───────────────────────────────────┘   └───────────────────────────────────┘
                    ↓                               ↓
┌───────────────────────────────────┐   ┌───────────────────────────────────┐
│   컴파일 & 링크                    │   │   컴파일 & 링크                   │
│   gcc -lfabric                    │   │   gcc (표준 라이브러리)           │
└───────────────────────────────────┘   └───────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                     실행 단계 (자동 처리)                                    │
└─────────────────────────────────────────────────────────────────────────────┘
                    ↓                               ↓
┌───────────────────────────────────┐   ┌───────────────────────────────────┐
│   libfabric API                   │   │   Socket API                      │
│   (고성능 HPC)                     │   │   (표준 소켓)                     │
└───────────────────────────────────┘   └───────────────────────────────────┘
                    ↓                               ↓
┌───────────────────────────────────┐   ┌───────────────────────────────────┐
│   fi_getinfo()                    │   │   TCP/IP Stack                    │
│   (Provider 탐색 - 자동)          │   │   (커널 경유)                     │
└───────────────────────────────────┘   └───────────────────────────────────┘
                    ↓                               ↓
        ┌───────────────────┐                      ↓
        │ EFA 사용 가능?    │                      ↓
        │ (libfabric 자동   │                      ↓
        │  탐색)            │                      ↓
        └───────────────────┘                      ↓
                    ↓                               ↓
        ┌───────────┴───────────┐                  ↓
        ↓                       ↓                  ↓
    ┌───────┐             ┌───────┐               ↓
    │ [예]  │             │[아니오]│               ↓
    └───────┘             └───────┘               ↓
        ↓                       ↓                  ↓
        ↓                       ↓                  ↓
┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐
│  EFA Provider    │  │  TCP Provider    │  │   TCP/IP         │
│  (OS-bypass)     │  │  (Kernel)        │  │   (일반)         │
├──────────────────┤  ├──────────────────┤  ├──────────────────┤
│ 특징:            │  │ 특징:            │  │ 특징:            │
│ • OS-bypass ✅   │  │ • 커널 경유      │  │ • 커널 경유      │
│ • RDMA ✅        │  │ • TCP/IP         │  │ • TCP/IP         │
│ • SRD 프로토콜 ✅│  │ • 낮은 성능      │  │ • EFA 미사용 ❌  │
│                  │  │                  │  │                  │
│ 성능:            │  │ 성능:            │  │ 성능:            │
│ • 지연: ~10μs ⚡ │  │ • 지연: 50-100μs │  │ • 지연: 50-100μs │
│ • 대역폭: 최대   │  │ • 대역폭: 제한적 │  │ • 대역폭: 보통   │
│ • CPU: 낮음      │  │ • CPU: 높음      │  │ • CPU: 높음      │
└──────────────────┘  └──────────────────┘  └──────────────────┘
        ↓                       ↓                  ↓
┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐
│ EFA 드라이버     │  │ TCP/IP 스택      │  │ TCP/IP 스택      │
│ (커널)           │  │ (커널)           │  │ (커널)           │
└──────────────────┘  └──────────────────┘  └──────────────────┘
        ↓                       ↓                  ↓
        └───────────────────────┴──────────────────┘
                            ↓
                ┌───────────────────────┐
                │   Network Hardware    │
                └───────────────────────┘

```



## EFA 전체 스택 아키텍처

```
┌─────────────────────────────────────────────────────────────────────┐
│                        APPLICATION LAYER                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │
│  │  NCCL Tests  │  │   PyTorch    │  │     MPI      │              │
│  │  (all_reduce)│  │ (Distributed)│  │ Applications │              │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘              │
│         │                  │                  │                       │
└─────────┼──────────────────┼──────────────────┼───────────────────────┘
          │                  │                  │
          ▼                  ▼                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    COMMUNICATION LIBRARIES                           │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                        NCCL Library                           │  │
│  │              (NVIDIA Collective Communications)               │  │
│  └────────────────────────┬─────────────────────────────────────┘  │
│                            │                                         │
│                            ▼                                         │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │              AWS OFI-NCCL Plugin                              │  │
│  │         (/opt/amazon/ofi-nccl/lib/libnccl-net.so)            │  │
│  │                                                                │  │
│  │  • GPU memory → CPU memory staging                            │  │
│  │  • NCCL network interface implementation                      │  │
│  └────────────────────────┬─────────────────────────────────────┘  │
│                            │                                         │
│  ┌────────────────────────┴─────────────────────────────────────┐  │
│  │                    OpenMPI / PMIX                             │  │
│  │              (/opt/amazon/openmpi)                            │  │
│  └────────────────────────┬─────────────────────────────────────┘  │
└───────────────────────────┼─────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      FABRIC INTERFACE LAYER                          │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                    Libfabric (OFI)                            │  │
│  │              (/opt/amazon/efa/lib/libfabric.so)              │  │
│  │                                                                │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │  │
│  │  │ EFA Provider│  │TCP Provider │  │Other Providers         │  │
│  │  │ (FI_PROVIDER│  │  (fallback) │  │             │          │  │
│  │  │    =efa)    │  │             │  │             │          │  │
│  │  └──────┬──────┘  └─────────────┘  └─────────────┘          │  │
│  │         │                                                      │  │
│  │         │ FI_EFA_USE_DEVICE_RDMA=0 (P5.48xlarge)             │  │
│  └─────────┼──────────────────────────────────────────────────────┘  │
└────────────┼─────────────────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      KERNEL SPACE                                    │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                  RDMA Core Subsystem                          │  │
│  │                                                                │  │
│  │  ┌─────────────────────────────────────────────────────────┐ │  │
│  │  │              ib_uverbs (User Verbs)                     │ │  │
│  │  │         /dev/infiniband/uverbs0                         │ │  │
│  │  └─────────────────────┬───────────────────────────────────┘ │  │
│  │                        │                                      │  │
│  │  ┌─────────────────────┴───────────────────────────────────┐ │  │
│  │  │              rdma_cm (Connection Manager)               │ │  │
│  │  │         /dev/infiniband/rdma_cm                         │ │  │
│  │  └─────────────────────┬───────────────────────────────────┘ │  │
│  └────────────────────────┼─────────────────────────────────────┘  │
│                            │                                         │
│  ┌────────────────────────┴─────────────────────────────────────┐  │
│  │                  EFA Kernel Module                            │  │
│  │                     (efa.ko)                                  │  │
│  │                                                                │  │
│  │  • Installed via: efa_2.17.3-1.amzn1                         │  │
│  │  • Loaded at boot after installation                         │  │
│  │  • Provides: /sys/class/infiniband/efa_0                     │  │
│  │  • CRITICAL: Must be properly loaded (needs reboot)          │  │
│  └────────────────────────┬─────────────────────────────────────┘  │
└───────────────────────────┼─────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      HARDWARE LAYER                                  │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │              EFA Network Interface Card                       │  │
│  │                    (Physical Device)                          │  │
│  │                                                                │  │
│  │  • Device: efa_0 (PCIe device)                               │  │
│  │  • Network: 100 Gbps (12.5 GB/s theoretical)                 │  │
│  │  • Protocol: Custom AWS protocol over Ethernet               │  │
│  │  • Low latency: ~10-20 microseconds                          │  │
│  └────────────────────────┬─────────────────────────────────────┘  │
└───────────────────────────┼─────────────────────────────────────────┘
                            │
                            ▼
                    ┌───────────────┐
                    │  AWS Network  │
                    │   Fabric      │
                    └───────────────┘

```

### 데이터 흐름 (P5.48xlarge NCCL 통신)
```
Node 1                                          Node 2
┌─────────────────────────────────────┐        ┌─────────────────────────────────────┐
│                                     │        │                                     │
│  ┌──────────────┐                  │        │                  ┌──────────────┐  │
│  │  GPU Memory  │                  │        │                  │  GPU Memory  │  │
│  │   (H100)     │                  │        │                  │   (H100)     │  │
│  └──────┬───────┘                  │        │                  └───────▲──────┘  │
│         │                           │        │                          │         │
│         │ (1) GPU→CPU copy          │        │          (6) CPU→GPU copy│         │
│         ▼                           │        │                          │         │
│  ┌──────────────┐                  │        │                  ┌──────────────┐  │
│  │ CPU Memory   │                  │        │                  │ CPU Memory   │  │
│  │ (Host RAM)   │                  │        │                  │ (Host RAM)   │  │
│  └──────┬───────┘                  │        │                  └───────▲──────┘  │
│         │                           │        │                          │         │
│         │ (2) NCCL call             │        │                          │         │
│         ▼                           │        │                          │         │
│  ┌──────────────┐                  │        │                  ┌──────────────┐  │
│  │  OFI-NCCL    │                  │        │                  │  OFI-NCCL    │  │
│  │   Plugin     │                  │        │                  │   Plugin     │  │
│  └──────┬───────┘                  │        │                  └───────▲──────┘  │
│         │                           │        │                          │         │
│         │ (3) Libfabric API         │        │                          │         │
│         ▼                           │        │                          │         │
│  ┌──────────────┐                  │        │                  ┌──────────────┐  │
│  │  Libfabric   │                  │        │                  │  Libfabric   │  │
│  │ (EFA Provider)│                 │        │                  │(EFA Provider)│  │
│  └──────┬───────┘                  │        │                  └───────▲──────┘  │
│         │                           │        │                          │         │
│         │ (4) Kernel system call    │        │                          │         │
│         ▼                           │        │                          │         │
│  ┌──────────────┐                  │        │                  ┌──────────────┐  │
│  │ EFA Kernel   │                  │        │                  │ EFA Kernel   │  │
│  │   Module     │                  │        │                  │   Module     │  │
│  └──────┬───────┘                  │        │                  └───────▲──────┘  │
│         │                           │        │                          │         │
│         │ (5) Hardware I/O          │        │          (5) Hardware I/O│         │
│         ▼                           │        │                          │         │
│  ┌──────────────┐                  │        │                  ┌──────────────┐  │
│  │  EFA NIC     │──────────────────┼────────┼──────────────────│  EFA NIC     │  │
│  │  (Hardware)  │   100 Gbps       │        │   100 Gbps       │  (Hardware)  │  │
│  └──────────────┘                  │        │                  └──────────────┘  │
│                                     │        │                                     │
└─────────────────────────────────────┘        └─────────────────────────────────────┘

```

### 컨테이너 환경에서의 마운트 구조
```
┌─────────────────────────────────────────────────────────────────────┐
│                          HOST SYSTEM                                 │
│                                                                       │
│  /opt/amazon/efa/                                                    │
│  ├── bin/                                                            │
│  │   └── fi_info, fi_pingpong                                       │
│  └── lib/                                                            │
│      └── libfabric.so ◄────────────────────┐                        │
│                                              │                        │
│  /opt/amazon/ofi-nccl/                      │                        │
│  └── lib/                                    │                        │
│      └── libnccl-net.so ◄────────────────┐  │                        │
│                                           │  │                        │
│  /dev/infiniband/                         │  │                        │
│  ├── uverbs0 ◄────────────────────────┐  │  │                        │
│  └── rdma_cm                           │  │  │                        │
│                                        │  │  │                        │
│  /sys/class/infiniband/efa_0/          │  │  │                        │
│                                        │  │  │                        │
└────────────────────────────────────────┼──┼──┼────────────────────────┘
                                         │  │  │
                         Container Mount │  │  │
                                         │  │  │
┌────────────────────────────────────────┼──┼──┼────────────────────────┐
│                    SLURM CONTAINER      │  │  │                        │
│                                         │  │  │                        │
│  --container-mounts:                    │  │  │                        │
│                                         │  │  │                        │
│  /dev/infiniband ───────────────────────┘  │  │                        │
│  (Device access for RDMA)                  │  │                        │
│                                             │  │                        │
│  /opt/amazon/efa ───────────────────────────┘  │                        │
│  (Libfabric library)                           │                        │
│                                                 │                        │
│  /opt/amazon/ofi-nccl ──────────────────────────┘                        │
│  (NCCL network plugin)                                                 │
│                                                                         │
│  --container-env:                                                      │
│  LD_LIBRARY_PATH=/opt/amazon/efa/lib:/opt/amazon/ofi-nccl/lib:...    │
│  FI_PROVIDER=efa                                                       │
│  NCCL_NET_GDR_LEVEL=0                                                  │
│                                                                         │
│  ┌──────────────────────────────────────────────────────────────┐    │
│  │              NCCL Test Application                            │    │
│  │         /opt/nccl-tests/build/all_reduce_perf                │    │
│  └──────────────────────────────────────────────────────────────┘    │
│                                                                         │
└─────────────────────────────────────────────────────────────────────┘

```


### 문제 진단 플로우

```
                    Start NCCL Test
                          │
                          ▼
              ┌───────────────────────┐
              │ NCCL initializes      │
              └───────────┬───────────┘
                          │
                          ▼
              ┌───────────────────────┐
              │ Load OFI-NCCL plugin  │
              └───────────┬───────────┘
                          │
                          ▼
              ┌───────────────────────┐
              │ Plugin calls Libfabric│
              └───────────┬───────────┘
                          │
                          ▼
              ┌───────────────────────┐
              │ Libfabric queries     │
              │ available providers   │
              └───────────┬───────────┘
                          │
                ┌─────────┴─────────┐
                │                   │
                ▼                   ▼
    ┌──────────────────┐  ┌──────────────────┐
    │ EFA provider     │  │ TCP provider     │
    │ available?       │  │ (fallback)       │
    └────┬─────────────┘  └──────────────────┘
         │                          ▲
    YES  │  NO                      │
         ▼                          │
    ┌──────────────────┐            │
    │ Try to open      │            │
    │ /dev/infiniband/ │            │
    │ uverbs0          │            │
    └────┬─────────────┘            │
         │                          │
    SUCCESS? ───NO──────────────────┘
         │                          
    YES  │                          
         ▼                          
    ┌──────────────────┐
    │ Initialize EFA   │
    │ communication    │
    └────┬─────────────┘
         │
         ▼
    ┌──────────────────┐
    │ High-speed       │
    │ EFA transport    │
    │ 8-11 GB/s        │
    └──────────────────┘

YOUR CURRENT STATE:
         │
         ▼
    ┌──────────────────┐
    │ EFA provider     │
    │ NOT available    │ ◄── Module not properly loaded
    └────┬─────────────┘
         │
         ▼
    ┌──────────────────┐
    │ Fallback to TCP  │
    │ 0.265 GB/s       │ ◄── Current performance
    └──────────────────┘

```
