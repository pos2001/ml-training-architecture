## EFA 전체 스택 아키텍처

```
┌─────────────────────────────────────────────────────────────────────┐
│                        APPLICATION LAYER                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │
│  │  NCCL Tests  │  │   PyTorch    │  │     MPI      │              │
│  │  (all_reduce)│  │ (Distributed)│  │ Applications │              │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘              │
│         │                  │                  │                       │
└─────────┼──────────────────┼──────────────────┼───────────────────────┘
          │                  │                  │
          ▼                  ▼                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    COMMUNICATION LIBRARIES                           │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                        NCCL Library                           │  │
│  │              (NVIDIA Collective Communications)               │  │
│  └────────────────────────┬─────────────────────────────────────┘  │
│                            │                                         │
│                            ▼                                         │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │              AWS OFI-NCCL Plugin                              │  │
│  │         (/opt/amazon/ofi-nccl/lib/libnccl-net.so)            │  │
│  │                                                                │  │
│  │  • GPU memory → CPU memory staging                            │  │
│  │  • NCCL network interface implementation                      │  │
│  └────────────────────────┬─────────────────────────────────────┘  │
│                            │                                         │
│  ┌────────────────────────┴─────────────────────────────────────┐  │
│  │                    OpenMPI / PMIX                             │  │
│  │              (/opt/amazon/openmpi)                            │  │
│  └────────────────────────┬─────────────────────────────────────┘  │
└───────────────────────────┼─────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      FABRIC INTERFACE LAYER                          │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                    Libfabric (OFI)                            │  │
│  │              (/opt/amazon/efa/lib/libfabric.so)              │  │
│  │                                                                │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │  │
│  │  │ EFA Provider│  │TCP Provider │  │Other Providers         │  │
│  │  │ (FI_PROVIDER│  │  (fallback) │  │             │          │  │
│  │  │    =efa)    │  │             │  │             │          │  │
│  │  └──────┬──────┘  └─────────────┘  └─────────────┘          │  │
│  │         │                                                      │  │
│  │         │ FI_EFA_USE_DEVICE_RDMA=0 (P5.48xlarge)             │  │
│  └─────────┼──────────────────────────────────────────────────────┘  │
└────────────┼─────────────────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      KERNEL SPACE                                    │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                  RDMA Core Subsystem                          │  │
│  │                                                                │  │
│  │  ┌─────────────────────────────────────────────────────────┐ │  │
│  │  │              ib_uverbs (User Verbs)                     │ │  │
│  │  │         /dev/infiniband/uverbs0                         │ │  │
│  │  └─────────────────────┬───────────────────────────────────┘ │  │
│  │                        │                                      │  │
│  │  ┌─────────────────────┴───────────────────────────────────┐ │  │
│  │  │              rdma_cm (Connection Manager)               │ │  │
│  │  │         /dev/infiniband/rdma_cm                         │ │  │
│  │  └─────────────────────┬───────────────────────────────────┘ │  │
│  └────────────────────────┼─────────────────────────────────────┘  │
│                            │                                         │
│  ┌────────────────────────┴─────────────────────────────────────┐  │
│  │                  EFA Kernel Module                            │  │
│  │                     (efa.ko)                                  │  │
│  │                                                                │  │
│  │  • Installed via: efa_2.17.3-1.amzn1                         │  │
│  │  • Loaded at boot after installation                         │  │
│  │  • Provides: /sys/class/infiniband/efa_0                     │  │
│  │  • CRITICAL: Must be properly loaded (needs reboot)          │  │
│  └────────────────────────┬─────────────────────────────────────┘  │
└───────────────────────────┼─────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      HARDWARE LAYER                                  │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │              EFA Network Interface Card                       │  │
│  │                    (Physical Device)                          │  │
│  │                                                                │  │
│  │  • Device: efa_0 (PCIe device)                               │  │
│  │  • Network: 100 Gbps (12.5 GB/s theoretical)                 │  │
│  │  • Protocol: Custom AWS protocol over Ethernet               │  │
│  │  • Low latency: ~10-20 microseconds                          │  │
│  └────────────────────────┬─────────────────────────────────────┘  │
└───────────────────────────┼─────────────────────────────────────────┘
                            │
                            ▼
                    ┌───────────────┐
                    │  AWS Network  │
                    │   Fabric      │
                    └───────────────┘

```

### 데이터 흐름 (P5.48xlarge NCCL 통신)
```
Node 1                                          Node 2
┌─────────────────────────────────────┐        ┌─────────────────────────────────────┐
│                                     │        │                                     │
│  ┌──────────────┐                  │        │                  ┌──────────────┐  │
│  │  GPU Memory  │                  │        │                  │  GPU Memory  │  │
│  │   (H100)     │                  │        │                  │   (H100)     │  │
│  └──────┬───────┘                  │        │                  └───────▲──────┘  │
│         │                           │        │                          │         │
│         │ (1) GPU→CPU copy          │        │          (6) CPU→GPU copy│         │
│         ▼                           │        │                          │         │
│  ┌──────────────┐                  │        │                  ┌──────────────┐  │
│  │ CPU Memory   │                  │        │                  │ CPU Memory   │  │
│  │ (Host RAM)   │                  │        │                  │ (Host RAM)   │  │
│  └──────┬───────┘                  │        │                  └───────▲──────┘  │
│         │                           │        │                          │         │
│         │ (2) NCCL call             │        │                          │         │
│         ▼                           │        │                          │         │
│  ┌──────────────┐                  │        │                  ┌──────────────┐  │
│  │  OFI-NCCL    │                  │        │                  │  OFI-NCCL    │  │
│  │   Plugin     │                  │        │                  │   Plugin     │  │
│  └──────┬───────┘                  │        │                  └───────▲──────┘  │
│         │                           │        │                          │         │
│         │ (3) Libfabric API         │        │                          │         │
│         ▼                           │        │                          │         │
│  ┌──────────────┐                  │        │                  ┌──────────────┐  │
│  │  Libfabric   │                  │        │                  │  Libfabric   │  │
│  │ (EFA Provider)│                 │        │                  │(EFA Provider)│  │
│  └──────┬───────┘                  │        │                  └───────▲──────┘  │
│         │                           │        │                          │         │
│         │ (4) Kernel system call    │        │                          │         │
│         ▼                           │        │                          │         │
│  ┌──────────────┐                  │        │                  ┌──────────────┐  │
│  │ EFA Kernel   │                  │        │                  │ EFA Kernel   │  │
│  │   Module     │                  │        │                  │   Module     │  │
│  └──────┬───────┘                  │        │                  └───────▲──────┘  │
│         │                           │        │                          │         │
│         │ (5) Hardware I/O          │        │          (5) Hardware I/O│         │
│         ▼                           │        │                          │         │
│  ┌──────────────┐                  │        │                  ┌──────────────┐  │
│  │  EFA NIC     │──────────────────┼────────┼──────────────────│  EFA NIC     │  │
│  │  (Hardware)  │   100 Gbps       │        │   100 Gbps       │  (Hardware)  │  │
│  └──────────────┘                  │        │                  └──────────────┘  │
│                                     │        │                                     │
└─────────────────────────────────────┘        └─────────────────────────────────────┘

```

### 컨테이너 환경에서의 마운트 구조
```
┌─────────────────────────────────────────────────────────────────────┐
│                          HOST SYSTEM                                 │
│                                                                       │
│  /opt/amazon/efa/                                                    │
│  ├── bin/                                                            │
│  │   └── fi_info, fi_pingpong                                       │
│  └── lib/                                                            │
│      └── libfabric.so ◄────────────────────┐                        │
│                                              │                        │
│  /opt/amazon/ofi-nccl/                      │                        │
│  └── lib/                                    │                        │
│      └── libnccl-net.so ◄────────────────┐  │                        │
│                                           │  │                        │
│  /dev/infiniband/                         │  │                        │
│  ├── uverbs0 ◄────────────────────────┐  │  │                        │
│  └── rdma_cm                           │  │  │                        │
│                                        │  │  │                        │
│  /sys/class/infiniband/efa_0/          │  │  │                        │
│                                        │  │  │                        │
└────────────────────────────────────────┼──┼──┼────────────────────────┘
                                         │  │  │
                         Container Mount │  │  │
                                         │  │  │
┌────────────────────────────────────────┼──┼──┼────────────────────────┐
│                    SLURM CONTAINER      │  │  │                        │
│                                         │  │  │                        │
│  --container-mounts:                    │  │  │                        │
│                                         │  │  │                        │
│  /dev/infiniband ───────────────────────┘  │  │                        │
│  (Device access for RDMA)                  │  │                        │
│                                             │  │                        │
│  /opt/amazon/efa ───────────────────────────┘  │                        │
│  (Libfabric library)                           │                        │
│                                                 │                        │
│  /opt/amazon/ofi-nccl ──────────────────────────┘                        │
│  (NCCL network plugin)                                                 │
│                                                                         │
│  --container-env:                                                      │
│  LD_LIBRARY_PATH=/opt/amazon/efa/lib:/opt/amazon/ofi-nccl/lib:...    │
│  FI_PROVIDER=efa                                                       │
│  NCCL_NET_GDR_LEVEL=0                                                  │
│                                                                         │
│  ┌──────────────────────────────────────────────────────────────┐    │
│  │              NCCL Test Application                            │    │
│  │         /opt/nccl-tests/build/all_reduce_perf                │    │
│  └──────────────────────────────────────────────────────────────┘    │
│                                                                         │
└─────────────────────────────────────────────────────────────────────┘

```


### 문제 진단 플로우

```
                    Start NCCL Test
                          │
                          ▼
              ┌───────────────────────┐
              │ NCCL initializes      │
              └───────────┬───────────┘
                          │
                          ▼
              ┌───────────────────────┐
              │ Load OFI-NCCL plugin  │
              └───────────┬───────────┘
                          │
                          ▼
              ┌───────────────────────┐
              │ Plugin calls Libfabric│
              └───────────┬───────────┘
                          │
                          ▼
              ┌───────────────────────┐
              │ Libfabric queries     │
              │ available providers   │
              └───────────┬───────────┘
                          │
                ┌─────────┴─────────┐
                │                   │
                ▼                   ▼
    ┌──────────────────┐  ┌──────────────────┐
    │ EFA provider     │  │ TCP provider     │
    │ available?       │  │ (fallback)       │
    └────┬─────────────┘  └──────────────────┘
         │                          ▲
    YES  │  NO                      │
         ▼                          │
    ┌──────────────────┐            │
    │ Try to open      │            │
    │ /dev/infiniband/ │            │
    │ uverbs0          │            │
    └────┬─────────────┘            │
         │                          │
    SUCCESS? ───NO──────────────────┘
         │                          
    YES  │                          
         ▼                          
    ┌──────────────────┐
    │ Initialize EFA   │
    │ communication    │
    └────┬─────────────┘
         │
         ▼
    ┌──────────────────┐
    │ High-speed       │
    │ EFA transport    │
    │ 8-11 GB/s        │
    └──────────────────┘

YOUR CURRENT STATE:
         │
         ▼
    ┌──────────────────┐
    │ EFA provider     │
    │ NOT available    │ ◄── Module not properly loaded
    └────┬─────────────┘
         │
         ▼
    ┌──────────────────┐
    │ Fallback to TCP  │
    │ 0.265 GB/s       │ ◄── Current performance
    └──────────────────┘

```
