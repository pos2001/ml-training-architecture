...
..
### 
```
┌─────────────────────────────────────────────────┐
│                  Node 1                         │
├─────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────┐ │
│  │         Process 1 (Rank 0, CPU)           │ │
│  │  - NCCL 라이브러리 호출                   │ │
│  │  - 통신 시작/종료 제어                    │ │
│  └───────────────────────────────────────────┘ │
│         │                    │                  │
│         │ (NCCL API)         │ (NCCL API)       │
│         ▼                    ▼                  │
│  ┌──────────┐         ┌──────────┐             │
│  │  GPU 0   │◄───────►│  GPU 1   │             │
│  │  Memory  │ NVLink  │  Memory  │             │
│  └──────────┘         └──────────┘             │
│         │                    │                  │
│         │ (PCIe/NVLink)      │                  │
│         └────────┬───────────┘                  │
│                  │                              │
│                  ▼                              │
│         ┌─────────────────┐                     │
│         │  Network Card   │                     │
│         │  (EFA/IB)       │                     │
│         │  - GPUDirect    │                     │
│         └─────────────────┘                     │
└──────────────────┼──────────────────────────────┘
                   │
                   │ 네트워크 (400 Gbps EFA)
                   │
┌──────────────────┼──────────────────────────────┐
│                  ▼                              │
│         ┌─────────────────┐                     │
│         │  Network Card   │                     │
│         │  (EFA/IB)       │                     │
│         │  - GPUDirect    │                     │
│         └─────────────────┘                     │
│                  │                              │
│         ┌────────┴───────────┐                  │
│         │ (PCIe/NVLink)      │                  │
│         ▼                    ▼                  │
│  ┌──────────┐         ┌──────────┐             │
│  │  GPU 0   │◄───────►│  GPU 1   │             │
│  │  Memory  │ NVLink  │  Memory  │             │
│  └──────────┘         └──────────┘             │
│         │                    │                  │
│         │ (NCCL API)         │ (NCCL API)       │
│         ▼                    ▼                  │
│  ┌───────────────────────────────────────────┐ │
│  │         Process 2 (Rank 1, CPU)           │ │
│  │  - NCCL 라이브러리 호출                   │ │
│  │  - 통신 시작/종료 제어                    │ │
│  └───────────────────────────────────────────┘ │
│                                                 │
│                  Node 2                         │
└─────────────────────────────────────────────────┘

```




### Process와 GPU의 관계, 실제로는 각 GPU마다 별도 프로세스가 있을 수 있습니다:
```
┌─────────────────────────────────────────────────┐
│                  Node 1                         │
├─────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────┐      │
│  │  Process (R0)   │  │  Process (R1)   │      │
│  │  - Rank 0       │  │  - Rank 1       │      │
│  └────────┬────────┘  └────────┬────────┘      │
│           │                    │                │
│           ▼                    ▼                │
│  ┌──────────┐         ┌──────────┐             │
│  │  GPU 0   │◄───────►│  GPU 1   │             │
│  └──────────┘         └──────────┘             │
│                                                 │
│  또는                                           │
│                                                 │
│  ┌───────────────────────────────────────────┐ │
│  │         Single Process (R0)               │ │
│  │  - 2개 GPU 모두 제어                      │ │
│  └───────────────────────────────────────────┘ │
│           │                    │                │
│           ▼                    ▼                │
│  ┌──────────┐         ┌──────────┐             │
│  │  GPU 0   │◄───────►│  GPU 1   │             │
│  └──────────┘         └──────────┘             │
└─────────────────────────────────────────────────┘

```






## 실제 통신 패턴
### 패턴 A: 1 Process per GPU (일반적 ⭐)
```
Node 1                          Node 2
┌─────────────────────┐        ┌─────────────────────┐
│ Process 0 (Rank 0)  │        │ Process 2 (Rank 2)  │
│        ↓            │        │        ↓            │
│   ┌────────┐        │        │   ┌────────┐        │
│   │ GPU 0  │────────┼────────┼───│ GPU 0  │        │
│   └────────┘        │  EFA   │   └────────┘        │
│                     │        │                     │
│ Process 1 (Rank 1)  │        │ Process 3 (Rank 3)  │
│        ↓            │        │        ↓            │
│   ┌────────┐        │        │   ┌────────┐        │
│   │ GPU 1  │────────┼────────┼───│ GPU 1  │        │
│   └────────┘        │  EFA   │   └────────┘        │
└─────────────────────┘        └─────────────────────┘

World Size = 4
각 프로세스가 1개 GPU 담당

```





### 패턴 B: 1 Process per Node (가능하지만 덜 일반적)
```
Node 1                          Node 2
┌─────────────────────┐        ┌─────────────────────┐
│ Process 0 (Rank 0)  │        │ Process 1 (Rank 1)  │
│        ↓      ↓     │        │        ↓      ↓     │
│   ┌────────┬────────┐        │   ┌────────┬────────┐
│   │ GPU 0  │ GPU 1  │────────┼───│ GPU 0  │ GPU 1  │
│   └────────┴────────┘  EFA   │   └────────┴────────┘
└─────────────────────┘        └─────────────────────┘

World Size = 2
각 프로세스가 2개 GPU 담당

```





### NCCL 통신 그룹
```
┌─────────────────────────────────────────────────┐
│            NCCL Communicator                    │
├─────────────────────────────────────────────────┤
│                                                 │
│  World: Rank 0, 1, 2, 3 (모든 GPU)              │
│                                                 │
│  ┌─────────────────────────────────────────┐   │
│  │  Rank 0 (Node 1, GPU 0)                 │   │
│  │  Rank 1 (Node 1, GPU 1)                 │   │
│  │  Rank 2 (Node 2, GPU 0)                 │   │
│  │  Rank 3 (Node 2, GPU 1)                 │   │
│  └─────────────────────────────────────────┘   │
│                                                 │
│  All-Reduce 시:                                 │
│  - 4개 Rank 모두 참여                           │
│  - NCCL이 최적 경로 자동 선택                   │
│                                                 │
└─────────────────────────────────────────────────┘

```





### All-Reduce 예시 (4 GPU)
```
Step 1: 각 GPU에서 Gradient 계산
┌─────────────────────────────────────────────────┐
│ Node 1                                          │
│ Rank 0: ∇W = -0.1                               │
│ Rank 1: ∇W = -0.2                               │
└─────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────┐
│ Node 2                                          │
│ Rank 2: ∇W = +0.1                               │
│ Rank 3: ∇W = -0.3                               │
└─────────────────────────────────────────────────┘

Step 2: NCCL All-Reduce 실행
┌─────────────────────────────────────────────────┐
│ Node 1                                          │
│ Process 0 → NCCL: allReduce(gpu0_grad)          │
│ Process 1 → NCCL: allReduce(gpu1_grad)          │
└─────────────────────────────────────────────────┘
         ↓ (노드 내 NVLink)
┌─────────────────────────────────────────────────┐
│ GPU 0 ↔ GPU 1: 데이터 교환                      │
└─────────────────────────────────────────────────┘
         ↓ (노드 간 EFA)
┌─────────────────────────────────────────────────┐
│ Node 1 ↔ Node 2: 데이터 교환                    │
└─────────────────────────────────────────────────┘
         ↓ (Ring AllReduce 알고리즘)
┌─────────────────────────────────────────────────┐
│ 평균 계산: (-0.1 - 0.2 + 0.1 - 0.3) / 4         │
│         = -0.125                                │
└─────────────────────────────────────────────────┘

Step 3: 결과 분배
┌─────────────────────────────────────────────────┐
│ Node 1                                          │
│ Rank 0: ∇W = -0.125                             │
│ Rank 1: ∇W = -0.125                             │
└─────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────┐
│ Node 2                                          │
│ Rank 2: ∇W = -0.125                             │
│ Rank 3: ∇W = -0.125                             │
└─────────────────────────────────────────────────┘

```




### 
```

```


